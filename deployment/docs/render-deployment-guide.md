# MAGSASA-CARD Platform - Render Deployment Guide

## Overview

This guide provides step-by-step instructions for deploying the MAGSASA-CARD AgriTech platform to Render for staging environment. Render provides a simple, reliable platform for hosting web applications with automatic deployments from Git repositories.

## Prerequisites

### 1. Render Account Setup
- Create a free account at [render.com](https://render.com)
- Connect your GitHub account to Render
- Verify your email address

### 2. Repository Setup
- Ensure your code is pushed to a GitHub repository
- Repository should contain all deployment configuration files
- Main application file: `app_production.py`
- Dependencies file: `requirements_production.txt`
- Render configuration: `deployment/render/render.yaml`

### 3. Environment Variables
Prepare the following environment variables:
- `OPENAI_API_KEY` - Your OpenAI API key for KaAni integration
- `GOOGLE_AI_API_KEY` - Your Google AI API key for comparison testing
- `SECRET_KEY` - Application secret key (can be auto-generated by Render)

## Deployment Steps

### Step 1: Create New Web Service

1. **Login to Render Dashboard**
   - Go to [dashboard.render.com](https://dashboard.render.com)
   - Click "New +" button
   - Select "Web Service"

2. **Connect Repository**
   - Choose "Build and deploy from a Git repository"
   - Select your GitHub repository
   - Choose the branch (typically `main` or `master`)

3. **Configure Service Settings**
   ```
   Name: magsasa-card-api-staging
   Environment: Python 3
   Region: Oregon (US West) - recommended for cost
   Branch: main
   Build Command: pip install --upgrade pip && pip install -r requirements_production.txt
   Start Command: gunicorn --bind 0.0.0.0:$PORT app_production:app --workers 2 --timeout 120
   ```

### Step 2: Configure Environment Variables

1. **Navigate to Environment Tab**
   - In your service dashboard, click "Environment"
   - Add the following variables:

   ```
   ENVIRONMENT=staging
   FLASK_ENV=production
   FLASK_DEBUG=false
   DATABASE_TYPE=sqlite
   DATABASE_PATH=/opt/render/project/src/database/dynamic_pricing.db
   ALLOWED_ORIGINS=*
   LOG_LEVEL=INFO
   PYTHONPATH=/opt/render/project/src
   ```

2. **Add AI Service Keys**
   ```
   OPENAI_API_KEY=your_openai_api_key_here
   GOOGLE_AI_API_KEY=your_google_ai_api_key_here
   ```

3. **Auto-Generate Secret Key**
   - Click "Generate" for `SECRET_KEY`
   - Render will create a secure random key

### Step 3: Configure Advanced Settings

1. **Health Check**
   ```
   Health Check Path: /health
   ```

2. **Auto-Deploy**
   - Enable "Auto-Deploy" for automatic deployments on Git push
   - Choose your deployment branch

3. **Build Settings**
   - Build Command: `pip install --upgrade pip && pip install -r requirements_production.txt`
   - Start Command: `gunicorn --bind 0.0.0.0:$PORT app_production:app --workers 2 --timeout 120`

### Step 4: Deploy Application

1. **Initial Deployment**
   - Click "Create Web Service"
   - Render will start building and deploying your application
   - Monitor the build logs for any errors

2. **Verify Deployment**
   - Once deployed, you'll receive a URL like: `https://magsasa-card-api-staging.onrender.com`
   - Test the health endpoint: `https://your-app-url.onrender.com/health`
   - Verify API endpoints are working

### Step 5: Configure Custom Domain (Optional)

1. **Add Custom Domain**
   - In service settings, go to "Custom Domains"
   - Add your staging domain (e.g., `staging-api.magsasa-card.com`)
   - Configure DNS records as instructed by Render

2. **SSL Certificate**
   - Render automatically provides SSL certificates
   - Verify HTTPS is working

## Using render.yaml Configuration

For automated deployment configuration, you can use the provided `render.yaml` file:

1. **Place render.yaml in Repository Root**
   ```bash
   cp deployment/render/render.yaml ./render.yaml
   ```

2. **Deploy from Blueprint**
   - In Render dashboard, click "New +"
   - Select "Blueprint"
   - Connect your repository
   - Render will read the `render.yaml` configuration

3. **Review and Deploy**
   - Review the services that will be created
   - Set environment variables as needed
   - Click "Apply" to deploy

## Monitoring and Maintenance

### Health Monitoring

1. **Built-in Monitoring**
   - Render provides basic monitoring in the dashboard
   - View logs, metrics, and deployment history

2. **Custom Health Checks**
   - The application includes `/health` endpoint
   - Monitor response time and status codes

3. **Log Management**
   - Access logs through Render dashboard
   - Use `tail -f` functionality for real-time logs

### Scaling

1. **Vertical Scaling**
   - Upgrade to paid plans for more resources
   - Increase memory and CPU allocation

2. **Horizontal Scaling**
   - Add multiple instances (paid feature)
   - Configure load balancing

### Backup Strategy

1. **Database Backup**
   - SQLite database is stored on persistent disk
   - Render provides automatic disk snapshots
   - Consider periodic manual backups

2. **Code Backup**
   - Code is backed up in Git repository
   - Deployment history available in Render

## Troubleshooting

### Common Issues

1. **Build Failures**
   ```bash
   # Check Python version compatibility
   python --version
   
   # Verify requirements.txt
   pip install -r requirements_production.txt
   
   # Check for missing dependencies
   pip check
   ```

2. **Application Startup Issues**
   ```bash
   # Test locally first
   python app_production.py
   
   # Check environment variables
   env | grep -E "(FLASK|DATABASE|API_KEY)"
   
   # Verify gunicorn command
   gunicorn --bind 0.0.0.0:5000 app_production:app
   ```

3. **Database Issues**
   ```bash
   # Check database file permissions
   ls -la src/database/
   
   # Verify database initialization
   python create_dynamic_pricing_db.py
   ```

### Performance Optimization

1. **Application Performance**
   - Use gunicorn with multiple workers
   - Implement caching for frequently accessed data
   - Optimize database queries

2. **Resource Usage**
   - Monitor memory usage in Render dashboard
   - Optimize Python imports and dependencies
   - Use connection pooling for external APIs

## Security Considerations

### Environment Variables
- Never commit API keys to Git repository
- Use Render's environment variable encryption
- Rotate API keys regularly

### Network Security
- Configure CORS properly for production
- Use HTTPS for all communications
- Implement rate limiting if needed

### Data Protection
- Encrypt sensitive data in database
- Implement proper authentication
- Follow data privacy regulations

## Automated Deployment

### Using Deployment Script

1. **Run Deployment Script**
   ```bash
   ./deployment/scripts/deploy-to-render.sh
   ```

2. **Monitor Deployment**
   - Script will push code to Git repository
   - Render will automatically deploy changes
   - Monitor deployment in Render dashboard

### CI/CD Integration

1. **GitHub Actions** (Optional)
   ```yaml
   # .github/workflows/deploy-staging.yml
   name: Deploy to Render Staging
   on:
     push:
       branches: [main]
   jobs:
     deploy:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v2
         - name: Trigger Render Deploy
           run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
   ```

## Cost Management

### Free Tier Limitations
- 750 hours per month (sufficient for staging)
- Automatic sleep after 15 minutes of inactivity
- Limited bandwidth and storage

### Optimization Tips
- Use free tier for staging environment
- Implement efficient resource usage
- Monitor usage in Render dashboard

## Next Steps

After successful Render deployment:

1. **Test All Features**
   - Verify API endpoints
   - Test KaAni integration
   - Check database functionality

2. **Set Up Monitoring**
   - Configure Notion integration
   - Set up health check alerts
   - Monitor application performance

3. **Prepare for Production**
   - Plan AWS production deployment
   - Set up database migration
   - Configure custom domain

## Support and Resources

### Render Documentation
- [Render Docs](https://render.com/docs)
- [Python Deployment Guide](https://render.com/docs/deploy-flask)
- [Environment Variables](https://render.com/docs/environment-variables)

### MAGSASA-CARD Resources
- Application health check: `/health`
- API documentation: `/`
- Deployment scripts: `deployment/scripts/`

### Getting Help
- Render Support: [help.render.com](https://help.render.com)
- GitHub Issues: Create issues in your repository
- Team Communication: Use configured Slack/email notifications

---

**Note**: This guide assumes you're using the staging environment configuration. For production deployment, refer to the AWS deployment guide.
